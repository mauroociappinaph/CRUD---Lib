import inquirer from "inquirer";
import schemas from "./lib/models/schemas.js"; // Importar todos los esquemas
import { addMissingFieldsBasedOnSchema } from "./lib/schemaCache.js"; // Funci√≥n para completar campos
import axios from "axios";

const API_URL = "http://localhost:3000/api"; // Cambiar seg√∫n tu configuraci√≥n

/**
 * CLI Interactivo para CRUD
 * @description
 * - Seleccionar un esquema (tabla) para operar
 * - Seleccionar una operaci√≥n CRUD para realizar
 * - Procesar la operaci√≥n seleccionada
 * - Volver al men√∫ principal
 */
async function runCLI() {
  console.log("üíª Bienvenido al CLI Interactivo para CRUD");
  console.log("üìÇ Esquemas disponibles:", Object.keys(schemas)); // Log de los esquemas disponibles

  // Seleccionar el esquema (tabla)
  const { selectedSchema } = await inquirer.prompt([
    {
      type: "list",
      name: "selectedSchema",
      message: "¬øSobre qu√© tabla deseas operar?",
      choices: Object.keys(schemas), // Ejemplo: ['User', 'Product']
    },
  ]);

  console.log(`üìå Esquema seleccionado: ${selectedSchema}`);

  // Preguntar qu√© operaci√≥n CRUD desea realizar
  const { operation } = await inquirer.prompt([
    {
      type: "list",
      name: "operation",
      message: "¬øQu√© operaci√≥n deseas realizar?",
      choices: [
        "GET (Listar)",
        "GET (Por ID)",
        "POST (Crear)",
        "PUT (Actualizar)",
        "DELETE (Eliminar)",
        "Exit",
      ],
    },
  ]);

  console.log(`‚öôÔ∏è Operaci√≥n seleccionada: ${operation}`);

  // Procesar la operaci√≥n seleccionada
  switch (operation) {
    case "GET (Listar)":
      await handleGetAll(selectedSchema);
      break;
    case "GET (Por ID)":
      await handleGetById(selectedSchema);
      break;
    case "POST (Crear)":
      await handleCreate(selectedSchema);
      break;
    case "PUT (Actualizar)":
      await handleUpdate(selectedSchema);
      break;
    case "DELETE (Eliminar)":
      await handleDelete(selectedSchema);
      break;
    case "Exit":
      console.log("üëã Gracias por usar el CLI. ¬°Hasta pronto!");
      process.exit();
  }

  // Volver al men√∫ principal
  console.log("üîÑ Regresando al men√∫ principal...");
  runCLI();
}

// Manejo de operaciones CRUD din√°micas
async function handleGetAll(schemaName) {
  console.log(`üìã Obteniendo todos los registros de ${schemaName}...`);

  // Solicitar par√°metros de paginaci√≥n y filtros al usuario
  const { page } = await inquirer.prompt([
    {
      type: "input",
      name: "page",
      message: "üî¢ Ingresa el n√∫mero de p√°gina (default 1):",
      default: 1,
      validate: (value) =>
        !isNaN(value) && value > 0 ? true : "Debe ser un n√∫mero positivo.",
    },
  ]);

  const { limit } = await inquirer.prompt([
    {
      type: "input",
      name: "limit",
      message: "üìè Ingresa el l√≠mite de resultados por p√°gina (default 10):",
      default: 10,
      validate: (value) =>
        !isNaN(value) && value > 0 ? true : "Debe ser un n√∫mero positivo.",
    },
  ]);

  const { filters } = await inquirer.prompt([
    {
      type: "input",
      name: "filters",
      message: 'üîç Ingresa los filtros en formato JSON (ej: {"name": "John"}):',
      default: "{}",
      validate: (value) => {
        try {
          JSON.parse(value);
          return true;
        } catch {
          return "Debe ser un JSON v√°lido.";
        }
      },
    },
  ]);

  // Parsear filtros
  const parsedFilters = JSON.parse(filters);

  // Construir la URL con par√°metros de consulta
  const queryParams = new URLSearchParams({
    page,
    limit,
    ...parsedFilters,
  }).toString();
  const url = `${API_URL}/${schemaName.toLowerCase()}s?${queryParams}`;
  console.log(`üåê URL de la solicitud: ${url}`);

  try {
    // Realizar la solicitud GET con los par√°metros
    const response = await axios.get(url);

    // Mostrar los datos obtenidos y la informaci√≥n de paginaci√≥n
    console.log(
      `‚úÖ Datos obtenidos (${schemaName}):`,
      response.data.documents || response.data
    );
    console.log(
      `üìÑ Total de registros: ${response.data.totalDocuments || "Desconocido"}`
    );
    console.log(
      `üìÑ P√°gina actual: ${response.data.currentPage || "1"} / ${
        response.data.totalPages || "1"
      }`
    );
  } catch (error) {
    console.error(`‚ùå Error al listar ${schemaName}:`, error.message);

    if (error.response) {
      console.error("üìã Detalles del error:", error.response.data);
    }
  }
}
async function handleGetById(schemaName) {
  console.log(
    `üìã Obteniendo todos los registros de ${schemaName} para seleccionar por nombre...`
  );

  const url = `${API_URL}/${schemaName.toLowerCase()}s`;
  console.log(`üåê URL de la solicitud: ${url}`);

  try {
    // Obtener todos los registros
    const response = await axios.get(url);
    const records = response.data;

    // Verificar si hay registros disponibles
    if (!records || records.length === 0) {
      console.log(`‚ö†Ô∏è No se encontraron registros para ${schemaName}.`);
      return;
    }

    // Crear opciones para selecci√≥n
    const options = records.map((record) => ({
      name: `${record.name} (ID: ${record._id})`,
      value: record._id,
    }));

    // Permitir al usuario seleccionar un registro
    const { id } = await inquirer.prompt([
      {
        type: "list",
        name: "id",
        message: `Selecciona un ${schemaName} por su nombre:`,
        choices: options,
      },
    ]);

    console.log(`üîç Obteniendo detalles del ${schemaName} con ID: ${id}`);

    // Realizar solicitud para obtener el detalle por ID
    const detailUrl = `${API_URL}/${schemaName.toLowerCase()}s/${id}`;
    const detailResponse = await axios.get(detailUrl);

    console.log(`‚úÖ Detalles del ${schemaName}:`, detailResponse.data);
  } catch (error) {
    console.error(`‚ùå Error al obtener el ${schemaName}:`, error.message);
    if (error.response) {
      console.error("üìã Detalles del error:", error.response.data);
    }
  }
}

async function handleCreate(schemaName) {
  console.log(`üõ†Ô∏è Creando un nuevo ${schemaName}...`);
  const schema = schemas[schemaName]?.schema;

  if (!schema) {
    console.error(`‚ùå No se encontr√≥ el esquema para ${schemaName}.`);
    return;
  }

  const autoGenerate = await inquirer.prompt([
    {
      type: "confirm",
      name: "autoGenerate",
      message: `¬øQuieres generar autom√°ticamente los datos del ${schemaName}?`,
    },
  ]);

  let data;
  if (autoGenerate.autoGenerate) {
    console.log("üõ†Ô∏è Generando datos autom√°ticamente...");
    data = addMissingFieldsBasedOnSchema({}, schema);
    console.log("üîß Datos generados autom√°ticamente:", data);
  } else {
    console.log("üìù Solicitando datos manualmente...");
    data = {};
    for (const field of Object.keys(schema.obj)) {
      const { required, type } = schema.obj[field];
      const typeInfo = type?.name || "String";
      const answer = await inquirer.prompt([
        {
          type: "input",
          name: field,
          message: `Ingrese ${field} (${
            required ? "requerido" : "opcional"
          }, tipo: ${typeInfo}):`,
        },
      ]);
      data[field] = answer[field];
    }
  }

  console.log("üì§ Enviando datos al servidor:", data);
  const url = `${API_URL}/${schemaName.toLowerCase()}s`;
  console.log(`üåê URL de la solicitud: ${url}`);

  try {
    const response = await axios.post(url, data);
    console.log(`‚úÖ ${schemaName} creado:`, response.data);
  } catch (error) {
    console.error(`‚ùå Error al crear el ${schemaName}:`, error.message);
    if (error.response) {
      console.error("üìã Detalles del error:", error.response.data);
    }
  }
}

async function handleUpdate(schemaName) {
  console.log(
    `üìã Obteniendo todos los registros de ${schemaName} para seleccionar por nombre...`
  );

  const url = `${API_URL}/${schemaName.toLowerCase()}s`;
  console.log(`üåê URL de la solicitud: ${url}`);

  try {
    const response = await axios.get(url);
    const records = response.data;

    if (!records || records.length === 0) {
      console.log(`‚ö†Ô∏è No se encontraron registros para ${schemaName}.`);
      return;
    }

    const options = records.map((record) => ({
      name: `${record.name} (ID: ${record._id})`,
      value: record._id,
    }));

    const { id } = await inquirer.prompt([
      {
        type: "list",
        name: "id",
        message: `Selecciona un ${schemaName} a actualizar:`,
        choices: options,
      },
    ]);

    console.log(`‚úèÔ∏è Actualizando ${schemaName} con ID: ${id}...`);
    const schema = schemas[schemaName]?.schema;

    if (!schema) {
      console.error(`‚ùå No se encontr√≥ el esquema para ${schemaName}.`);
      return;
    }

    const { autoGenerate } = await inquirer.prompt([
      {
        type: "confirm",
        name: "autoGenerate",
        message:
          "¬øQuieres generar autom√°ticamente los datos para la actualizaci√≥n?",
      },
    ]);

    let data;
    if (autoGenerate) {
      console.log("üõ†Ô∏è Generando datos autom√°ticamente...");
      data = addMissingFieldsBasedOnSchema({}, schema);
      console.log("üîß Datos generados autom√°ticamente:", data);
    } else {
      console.log("üìù Solicitando datos manualmente...");
      data = {};
      for (const field of Object.keys(schema.obj)) {
        const { required, type } = schema.obj[field];
        const typeInfo = type?.name || "String";
        const answer = await inquirer.prompt([
          {
            type: "input",
            name: field,
            message: `Ingrese ${field} (${
              required ? "requerido" : "opcional"
            }, tipo: ${typeInfo}):`,
          },
        ]);
        if (answer[field]) {
          data[field] = answer[field];
        }
      }
    }

    console.log("üì§ Enviando datos al servidor:", data);
    const updateUrl = `${API_URL}/${schemaName.toLowerCase()}s/${id}`;
    console.log(`üåê URL de la solicitud: ${updateUrl}`);

    try {
      const response = await axios.put(updateUrl, data);
      console.log(`‚úÖ ${schemaName} actualizado:`, response.data);
    } catch (error) {
      console.error(`‚ùå Error al actualizar el ${schemaName}:`, error.message);
      if (error.response) {
        console.error("üìã Detalles del error:", error.response.data);
      }
    }
  } catch (error) {
    console.error(
      `‚ùå Error al obtener registros para ${schemaName}:`,
      error.message
    );
    if (error.response) {
      console.error("üìã Detalles del error:", error.response.data);
    }
  }
}
async function handleDelete(schemaName) {
  console.log(
    `üìã Obteniendo todos los registros de ${schemaName} para seleccionar por nombre...`
  );

  const url = `${API_URL}/${schemaName.toLowerCase()}s`;
  console.log(`üåê URL de la solicitud: ${url}`);

  try {
    const response = await axios.get(url);
    const records = response.data;

    if (!records || records.length === 0) {
      console.log(`‚ö†Ô∏è No se encontraron registros para ${schemaName}.`);
      return;
    }

    const options = records.map((record) => ({
      name: `${record.name} (ID: ${record._id})`,
      value: record._id,
    }));

    const { id } = await inquirer.prompt([
      {
        type: "list",
        name: "id",
        message: `Selecciona un ${schemaName} a eliminar:`,
        choices: options,
      },
    ]);

    console.log(`üóëÔ∏è Eliminando ${schemaName} con ID: ${id}`);
    const deleteUrl = `${API_URL}/${schemaName.toLowerCase()}s/${id}`;
    console.log(`üåê URL de la solicitud: ${deleteUrl}`);

    try {
      const response = await axios.delete(deleteUrl);
      console.log(`‚úÖ ${schemaName} eliminado:`, response.data);
    } catch (error) {
      console.error(`‚ùå Error al eliminar el ${schemaName}:`, error.message);
      if (error.response) {
        console.error("üìã Detalles del error:", error.response.data);
      }
    }
  } catch (error) {
    console.error(
      `‚ùå Error al obtener registros para ${schemaName}:`,
      error.message
    );
    if (error.response) {
      console.error("üìã Detalles del error:", error.response.data);
    }
  }
}

// Iniciar el CLI
runCLI();
